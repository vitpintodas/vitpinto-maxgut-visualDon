<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Titre de la page</title>

    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Color palette -->
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <style>
      #my_dataviz {
        margin: 0 auto;
        display: block;
      }

      .node:hover {
        stroke-width: 7px !important;
        opacity: 1 !important;
      }

      .tooltip {
        position: absolute;
        text-align: center;
        width: 500px;
        height: 200px;
        padding: 10px;
        font: 50px sans-serif;
        background: yellow;
        border: 0px;
        border-radius: 40px;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <!-- Create a div where the graph will take place -->
    <div id="my_dataviz"></div>
    <!--<div class="tooltip"></div>-->

    <script>
      // dimensions du graphe
      const width = 3840;
      const height = 2160;

      // chargement des données
      d3.csv("data.csv").then(function (data) {
        // création du tableau des responsables de la mort avec le nombre de morts qu'ils ont causés
        const dataMap = d3.rollup(
          data,
          (v) => v.length,
          (d) => d["Responsable de la mort"]
        );
        const responsables = Array.from(dataMap, ([key, value]) => ({
          key,
          value,
        }));

        // création de la mise en page
        const svg = d3
          .select("#my_dataviz")
          .append("svg")
          .attr("width", width)
          .attr("height", height);

        // création de la variable tooltip
        const tooltip = d3
          .select("body")
          .append("div")
          .attr("class", "tooltip")
          .style("visibility", "hidden");

        // création de la simulation de forces pour les bulles
        const simulation = d3
          .forceSimulation(responsables)
          .force("charge", d3.forceManyBody().strength(-7500))
          .force("x", d3.forceX(width / 2))
          .force("y", d3.forceY(height / 2))
          .force(
            "collision",
            d3.forceCollide().radius(function (d) {
              return d.value + 8;
            })
          );

        // création des bulles pour chaque responsable
        const bubble = svg
          .selectAll(".bubble")
          .data(responsables)
          .join("circle")
          .attr("class", "bubble")
          .attr("r", function (d) {
            return d.value * 11;
          })
          .attr("cx", width / 2)
          .attr("cy", height / 2)
          .attr("fill", "green")
          .attr("opacity", 1)
          .on("mouseover", function (d) {
            d3.select(this).attr("opacity", 1.0);
            tooltip.style("visibility", "visible");
            tooltip.text(d.key);
            tooltip.text(d.key + " - " + d.value + " victime(s)");
            console.log(d);
            console.log(d.value);
          })
          .on("mousemove", function () {
            tooltip
              .style("top", event.pageY - 10 + "px")
              .style("left", event.pageX + 10 + "px");
          })
          .on("mouseout", function () {
            d3.select(this).attr("opacity", 1);
            tooltip.style("visibility", "hidden");
          });

        //créer les étiquettes pour chaques bulles (ne sert a rien, mais sinon il y a des erreurs)
        const label = svg
          .selectAll(".label")
          .data(responsables)
          .enter()
          .append("text")
          .attr("class", "label")
          .attr("text-anchor", "middle")
          .text(function (d) {
            return d.key;
          })
          .attr("font-size", 0);

        // mise à jour des positions des bulles à chaque étape de la simulation de forces
        simulation.on("tick", function () {
          bubble
            .attr("cx", function (d) {
              return d.x;
            })
            .attr("cy", function (d) {
              return d.y;
            });
          label
            .attr("x", function (d) {
              return d.x;
            })
            .attr("y", function (d) {
              return d.y + d.value + 5;
            });
        });
      });
    </script>
  </body>
</html>
